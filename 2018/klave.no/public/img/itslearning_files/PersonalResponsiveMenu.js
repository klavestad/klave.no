function PersonalResponsiveMenuInit(g){function f(b){jQuery.ajax({type:"GET",url:q.personalMessageSourceUrl,success:function(a){C=a;H=new Date;e.updateMessageCounterBasedOnCookie();b&&m(a)},error:CommonFunctions.alertAjaxError})}function m(b){a.messageDialogContent.empty().html(b);b=-(a.inboxMenuLink.width()/2+ +a.inboxMenuLink.css("padding-right").replace("px","")+ +a.inboxMenuLink.css("border-right-width").replace("px","")+ +a.inboxMenuLink.css("margin-right").replace("px",""));var Q=-(a.inboxMenuLink.height()/
2+ +a.inboxMenuLink.css("padding-bottom").replace("px","")+ +a.inboxMenuLink.css("border-bottom-width").replace("px","")+ +a.inboxMenuLink.css("margin-bottom").replace("px",""));l.openDialogAt(b,Q,!0);c.isAndroidBrowser||r();t(a.inboxMenuLink.closest("li"),!0);L();M();N()}function y(){I&&clearTimeout(I);I=setTimeout(r,200)}function r(){var b=a.messageDialogContent,c=z.height()-b.offset().top-(b.outerHeight(!0)-b.height());b.css({"max-height":0>c?0:c,"overflow-y":"auto"})}function u(){return{width:400,
setFocus:!1,marginTop:38,marginBottom:0,showArrow:!0,align:"center",valign:"bottom",cssClass:D.popupContainer,customScripts:{beforeCloseDialog:null}}}function d(b){k=O(b,a.notificationLink,a.notificationDialogContent);k.setBeforeCloseDialog(function(){t(a.notificationLink.closest("li"),!!a.notificationsBadge.text())});k.hideHeader();k.hideFooter();k.toggleCloseLink(!1)}function R(b){l=O(b,a.inboxMenuLink,a.messageDialogContent);l.setBeforeCloseDialog(function(){t(a.inboxMenuLink.closest("li"),!!a.messagesBadge.text())});
l.hideHeader();l.hideFooter();l.toggleCloseLink(!1)}function O(b,a,c){b.toggleElement=a;return new ContextDialog(c,b)}function S(){if(k.isOpened()){var b=a.notificationDialogContent.find("li."+D.unreadNotificationItem);0<b.length&&jQuery.ajax({type:"POST",url:q.updateReadNotifications,data:{notifications:T(b).join()}});b=parseInt(jQuery("#"+a.unreadNotificationsCountHiddenId).val());E(b,0<b||k.isOpened())}}function U(){jQuery.ajax({type:"POST",url:q.markAllNotificationsAsSeen,data:{}});E(0,!1)}function T(b){return b.map(function(b,
a){return jQuery(a).data("id")}).toArray()}function E(b,c){h(b,a.notificationLink,a.notificationsBadge,!!c)}function h(b,a,c,e){t(a.closest("li"),e);c.text(A(b,!0));c.toggle(0<b)}function t(b,a){b.toggleClass(D.opaque,a)}function M(){a.messageDialogContent.find("#"+c.messageCounterIds.internalMessagesCounter).text(F(A(p)))}function L(){if(!window.itslearning.settings.app.is_instant_message_system_enabled){var b=c.primaryCloudEmailType===CloudEmailType.office365?F(A(v,!1)):F(A(w,!1));a.messageDialogContent.find("#"+
c.messageCounterIds.cloudMessagesCounter).text(b)}}function N(){a.messageDialogContent.find("#"+c.messageCounterIds.skoleIntraMessagesCounter).text(F(A(B,!1)))}function A(b,a){return void 0===b||0>=b?"":a&&100<=b?"99+":b}function F(b){return""===b?"":" ("+b+")"}window[g]=this;var e=this,z=jQuery(window),a,c,q,D,x,k,l,I,J=0,n=0,v=0,w=0,p=0,P,C,G=0,H,K,B=0;e.initialize=function(){a=e.controls;c=e.settings;q=e.settings.urls;D=e.settings.cssClasses;x=e.settings.queryStringParameters;K=e.toggleMenuLinkFunction;
a.personalMenuLink.on("click",function(){"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click();K});CommonFunctions.setupDropDownMenu(c.isIos,a.personalMenuLink,a.personalMenuDropDown,K);a.searchBoxMobile.on("click touchstart touchend",function(b){b.stopPropagation()});a.searchBox.add(a.searchBoxMobile).on(c.searchTextEvent,function(b,a){top.location.href=q.searchMainPageNavigateUrl.replace(c.searchPlaceholder,encodeURIComponent(encodeURIComponent(a)))});
a.notificationLink.click(function(b){if(k.isOpened())k.closeDialog();else{jQuery(InstantMessageSelectors.overlaySelector).click();var e=-(a.notificationLink.width()/2+ +a.notificationLink.css("padding-right").replace("px","")+ +a.notificationLink.css("border-right-width").replace("px","")+ +a.notificationLink.css("margin-right").replace("px","")),d=-(a.notificationLink.height()/2+ +a.notificationLink.css("padding-bottom").replace("px","")+ +a.notificationLink.css("border-bottom-width").replace("px",
"")+ +a.notificationLink.css("margin-bottom").replace("px",""));if(c.hasSkoleIntraNotifications&&""!==c.skoleIntraNotificationsBellUrl){var f=$(a.notificationDialogContent),h=f.find(".c-spinner-bounce"),g=f.find("iframe");f.removeClass(c.notificationsLoadedClass);g.attr("src",c.skoleIntraNotificationsBellUrl);$(g).on("load",function(){h.hide();f.addClass(c.notificationsLoadedClass);setTimeout(U,500);g.show()});g.hide();h.show();k.openDialogAt(e,d,!0);t(a.notificationLink.closest("li"),!0)}else jQuery.ajax({type:"GET",
url:q.personalNotificationSourceUrl,success:function(b){a.notificationDialogContent.html(b);k.openDialogAt(e,d,!0);t(a.notificationLink.closest("li"),!0);setTimeout(S,3E3)},error:CommonFunctions.alertAjaxError})}});c.shouldOpenMessagesPopUp&&(a.inboxMenuLink.click(function(b){l.isOpened()?l.closeDialog():((b=!C)||(b=H?18E4<(new Date).getTime()-H.getTime():!1),b?f(!0):m(C))}),c.isAndroidBrowser||z.resize(y),z.on("load",function(){f()}));E(0,!1);h(0,a.office365CloudEmailIconLink,a.office365CloudEmailBadge,
!1);h(0,a.gmailCloudEmailIconLink,a.gmailCloudEmailBadge,!1);h(0,a.inboxMenuLink,a.messagesBadge,!1);h(0,a.emailMenuLink,a.emailBadge,!1);h(0,a.skoleIntraMessagesIconLink,a.skoleIntraMessagesBadge,!1);CommonFunctions.attachPostMessageEventListener(z,CommonWindowMessages.MessageNames.unreadNotificationCounterChanged,function(b){E(b.extendedData,0<b.extendedData||k.isOpened())});CommonFunctions.attachPostMessageEventListener(z,CommonWindowMessages.MessageNames.unreadMessagesCounterChanged,function(b){jQuery.ajax({type:"GET",
url:e.settings.urls.updateNumberOfUnreadMessagesUrl,success:function(b){c.hasSkoleIntraMessages&&h(b,a.skoleIntraMessagesIconLink,a.skoleIntraMessagesBadge,!1)},error:CommonFunctions.alertAjaxError})});d(u());c.shouldOpenMessagesPopUp&&R(u());c.hasInternalMessages&&(P=new RegExp("[\\?&]"+c.onlineInfoCookie.unreadMessagesKey+"=([^&#]*)"));c.hasEmail&&(numberOfUnreadEmailCookieRegex=new RegExp("[\\?&]"+c.onlineInfoCookie.unreadEmailKey+"=([^&#]*)"))};e.setUnreadInternalMessages=function(b){c.hasInternalMessages&&
b!==n&&(n=b,M())};e.setUnreadEmailMessages=function(b,a){c.hasEmail&&b!==p&&(p=b,G=a)};e.setUnreadCloudEmailMessages=function(b,a){!c.hasCloudEmail||v===b&&w===a||(v=b,w=a,L())};e.setUnreadSkoleIntraMessages=function(a){c.hasSkoleIntraMessages&&B!==a&&(B=a,N())};e.updateMessageCounterBasedOnCookie=function(){if(c.hasInternalMessages){var a=P.exec(jQuery.cookie(c.onlineInfoCookie.name));a&&a.length&&(n=parseInt(a[1]),e.setCounts())}};e.setCounts=function(){J&&n!==J&&e.invalidateCache();if(G&&0<G&&
window.itslearning.settings.app.is_instant_message_system_enabled){var b=e.controls.emailMenuLink.attr("href"),d=b.getQueryStringParameter(x.textURL);d=d.setQueryStringParameter(x.emailAccountsRedirect,"False");d=d.setQueryStringParameter(x.emailRedirect,"True");d=d.setQueryStringParameter(x.accountID,G);e.controls.emailMenuLink.attr("href",b.setQueryStringParameter(x.textURL,d))}J=n;b=0;0<n&&(c.hasInternalMessages||c.hasEmail)&&(b+=n,window.itslearning.settings.app.is_instant_message_system_enabled&&
(window.itslearning.instantmessaging.unreadInternalMessages=n));(0<v||0<w)&&c.hasCloudEmail&&(window.itslearning.settings.app.is_instant_message_system_enabled?(h(v,a.office365CloudEmailIconLink,a.office365CloudEmailBadge,!1),h(w,a.gmailCloudEmailIconLink,a.gmailCloudEmailBadge,!1)):b=c.primaryCloudEmailType===CloudEmailType.office365?b+v:b+w);0<B&&c.hasSkoleIntraMessages&&h(B,a.skoleIntraMessagesIconLink,a.skoleIntraMessagesBadge,!1);!window.itslearning.settings.app.is_instant_message_system_enabled&&
c.hasEmail&&(b+=p);0<p&&c.hasEmail&&h(p,a.emailMenuLink,a.emailBadge,!!(0<p));if(c.hasInternalMessages||c.hasCloudEmail||c.hasEmail)d=0<b||e.settings.shouldOpenMessagesPopUp&&l.isOpened(),h(b,a.inboxMenuLink,a.messagesBadge,!!d);CommonFunctions.makePostMessageCall(window.top,new CommonWindowMessages.GenericMessageWithData(CommonWindowMessages.MessageNames.unreadNotificationCounterChanged,e.unreadNotifications));window.itslearning.settings.app.is_instant_message_system_enabled&&(b=jQuery.Event("UpdateUnreadMessagesCount"),
jQuery(window).trigger(b))};e.invalidateCache=function(){C=void 0};return e}var CloudEmailType={office365:"Office365",gmail:"Gmail"},InstantMessageSelectors={largeHeaderLogo:".l-logo",mainMenuSelector:"ul.l-main-menu-items",overlayClass:"c-messages__overlay",overlaySelector:".c-messages__overlay",overlayLargeSelector:"c-messages__overlay--largeHeader",overlayBlackClass:"c-messages__overlay--black",popupSelector:".c-messages-popup",popupIconSelector:".l-personal-menu-instantmessage",popupIconSelectedClass:"l-personal-menu-icon-instantmessage-selected"};
function FlyOutPopupInit(g){jQuery("body").append('<div class="'+InstantMessageSelectors.overlayClass+' is-hidden"></div>');0<jQuery(InstantMessageSelectors.largeHeaderLogo).length&&jQuery(InstantMessageSelectors.overlaySelector).addClass(InstantMessageSelectors.overlayLargeSelector);jQuery(InstantMessageSelectors.popupSelector).load(g);jQuery(InstantMessageSelectors.popupIconSelector).on("click",function(){var f=jQuery(this);"true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")?
(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),jQuery(InstantMessageSelectors.mainMenuSelector).on("click",function(f){jQuery(InstantMessageSelectors.mainMenuSelector).off("click");"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click()}),"undefined"!==typeof window.InstantMessageOpenWindow&&window.InstantMessageOpenWindow()):
jQuery(InstantMessageSelectors.overlaySelector).click();jQuery(f).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass)});jQuery(InstantMessageSelectors.overlaySelector).on("click",function(f){f=jQuery(f.target);if(f.hasClass(InstantMessageSelectors.overlayClass)||f.hasClass(InstantMessageSelectors.overlayBlackClass))jQuery(this).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass(InstantMessageSelectors.overlayBlackClass),
jQuery(InstantMessageSelectors.overlaySelector).addClass("is-hidden"),jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","true"),"undefined"!==typeof window.InstantMessageCloseWindow&&window.InstantMessageCloseWindow()})}
function OpenInstantMessageSendNew(g){"undefined"!==typeof window.showInstantMessageSendNew&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.showInstantMessageSendNew(g))}
function OpenInstantMessageModal(){"undefined"!==typeof window.InstantMessageOpenModalWindow?openInstentMessageModalWindow():window.setTimeout(openInstentMessageModalWindow,3E3)}
function openInstentMessageModalWindow(){"undefined"!==typeof window.InstantMessageOpenModalWindow&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.InstantMessageOpenModalWindow())}
jQuery(function(){if(window.itslearning.settings.app.is_instant_message_system_enabled){var g=function(d){d?10>=y&&(y+=1,window.clearInterval(r),r=window.setInterval(f,3E4)):(window.clearInterval(r),y=0)},f=function(){jQuery.connection.hub.start().done(function(){var d="";localStorage.getItem("instantmessage-channelid")&&(d=localStorage.getItem("instantmessage-channelid"));var f="/restapi/personal/instantmessages/communicationchannel/{channelId}/v1".replace("{channelId}",jQuery.connection.hub.id);
5<d.length&&(f=f+"?unregister="+d);jQuery.ajax({type:"POST",url:f,success:function(d){m(!0);g(!1);console.log("SignalR connection registered. ChannelId: "+jQuery.connection.hub.id)}});localStorage.setItem("instantmessage-channelid",jQuery.connection.hub.id)}).fail(function(d){m(!1);g(!0);console.log("Error starting SignalR connection: "+d)})},m=function(d){var f=jQuery.Event("SignalRConnectionStatus");jQuery(window).trigger(f,d)},y=0,r;jQuery.connection.hub.url=window.itslearning.settings.app.signal_r_endpoint;
var u=jQuery.connection.instantMessageHub;"undefined"!==typeof u&&null!==u&&(u.client.alertNewMessage=function(d){d=JSON.parse(d);var f=jQuery.Event("NewSignalRInstantMessage");jQuery(window).trigger(f,d)});f();jQuery.connection.hub.connectionSlow(function(){console.log("We are currently experiencing difficulties with the connection.")});jQuery.connection.hub.reconnecting(function(){m(!1);console.log("SignalR connection reconnecting.")});jQuery.connection.hub.disconnected(function(){m(!1);console.log("SignalR connection disconnected.");
g(!0)});jQuery.connection.hub.reconnected(function(){m(!0);console.log("SignalR connection reconnected.");g(!1)})}});
