function PersonalMessagesManager(y){function v(a){return $(String.format("<div class='{0}'></div>",c.sendSuccessResult)).append(String.format("<img src='{0}' alt='' />",g.sendSuccessImageSrc)).append(String.format("<span>{0}</span>",String.format(h.messageSentTo,a)))}function z(a){return $(String.format("<div class='{0}'></div>",c.sendFailedResult)).append("<span>"+h.failedToSendMessage+"</span>").append($("<a href='#'>"+h.retrySend+"</a>").on(d.settings.clickOrTouch,function(b){a();b.preventDefault();
$(this).parent().remove()}))}function w(a){a.parent().find('input[type="submit"]').prop("disabled",""===a.val().trim())}function A(a,b){var f=b.find("."+c.attachmentsContainer);0<f.length&&0===f.find("ul").length&&$.ajax({type:"GET",url:g.getAttachmentsUrl,data:{messageId:a},success:function(a){f.append(a)},error:CommonFunctions.alertAjaxError})}function B(a,b,c){$.ajax({type:"POST",url:g.markMessageAsReadUrl,data:{messageIdArray:a,messageOrigin:c},success:function(){q(b,l.markedAsRead)},error:CommonFunctions.alertAjaxError})}
function x(a,b,c,d,r,e,h,m){$.ajax({type:"POST",url:g.sendMessageUrl,data:{initialId:b,to:c,subject:d,isNewMessage:h,text:a.messageBody,messageOrigin:m},success:function(){a.sendMessageSuccessCallback();r&&r()},error:function(a,b,c){e?e(a,b,c):CommonFunctions.alertAjaxError()},complete:function(){a.sendMessageCompleteCallback()}})}function q(a,b){a=a.closest("li."+c.messageItem);var f={lastItemDeleted:!1,updateCounter:b===l.deleted||b===l.markedAsRead};b===l.deleted?(0===a.siblings("li."+c.messageItem).length&&
(f.lastItemDeleted=!0),a.remove()):a.removeClass(c.unreadMessageItem);if(d.callbacks.onMessageAction)d.callbacks.onMessageAction(f)}window[y]=this;var d=this,l={deleted:0,markedAsRead:1,toggledFavoriteStatus:2},h,g,c,k,t,p,e;d.callbacks={};d.initialize=function(){h=d.settings.terms;g=d.settings.urls;c=d.settings.cssClasses;p=d.settings.messageOrigins;e=d.settings.kpi;k=d.settings.clientIds;d.settings.clientInstanceNames.participantsInputClientInstanceName&&(t=d.settings.clientInstanceNames.participantsInputClientInstanceName);
setTimeout(function(){$("."+c.messageItem).each(function(){var a=$(this);a.find(String.format(".{0} a",c.textToggle)).on(d.settings.clickOrTouch,function(){var b=a.find("."+c.text).get(0);b=$(b);b.hasClass(c.collapsed)?(b.removeClass(c.collapsed),$(this).text(h.showLess)):(b.addClass(c.collapsed),$(this).text(h.showMore));return!1})}).on("keyup","."+c.sendMessageInlineReply+" textarea",function(a){w($(a.target))})},0);$("."+c.messageItem).find("."+c.sendMessageInlineReply).hide()};d.toggleNewMessage=
function(a,b){a.toggle();a.is(":visible")&&(window[t].focus(),b==p.dropDown&&CommonFunctions.measureKpi(e.url,e.section,e.measurements.createNewMessage,e.context))};d.toggleMessage=function(a,b,d,n){var f=b.closest("li."+c.messageItem),g=b.find("."+c.text),k=b.find("."+c.textToggle);f.find(String.format(".{0} .{1}",c.head,c.subject)).toggleClass(c.collapsed);var m=b.find("*[data-message-text]");if(0<m.length){var l=$("<div></div>").html(m.data("message-text"));m.prepend(l);m.removeAttr("data-message-text")}b.toggle();
b.is(":visible")?(d===p.dropDown&&CommonFunctions.measureKpi(e.url,e.section,e.measurements.viewMessage,e.context),f.hasClass(c.unreadMessageItem)&&B(a,b,d),b=g.find("div").height(),g.toggleClass(c.collapsed,130<=b),k.toggle(130<=b),A(a,f),n.length&&n.is(":visible")&&n.find("textarea").focus()):(g.toggleClass(c.collapsed,!0),k.find("a").text(h.showMore))};d.toggleReplyMessage=function(a,b){a.toggle();var c=a.find("textarea");w(c);a.is(":visible")&&(c.focus(),b==p.dropDown&&CommonFunctions.measureKpi(e.url,
e.section,e.measurements.replyToMessage,e.context))};d.deleteMessage=function(a,b,c){confirm(h.deleteConfirmation)&&$.ajax({type:"POST",url:g.deleteMessageUrl,data:{messageIdArray:a,messageOrigin:c},success:function(){q(b,l.deleted)},error:CommonFunctions.alertAjaxError})};d.sendMessage=function(a,b,d,e,h,g,k,m){x(a,d,e,g,function(){m();var a=$("#"+b);a.after(function(){return v(h)});a.next("."+c.sendSuccessResult).delay(2E3).fadeOut(300).promise().done(function(){$(this).remove()})},void 0,!1,k)};
d.sendQuickMessage=function(a,b,e,g,k,l,p,m,q){var f=window[t],r=$("#"+b),n=$("#"+e),u=$("#"+k);f.hasText()?(u.show(),$("#"+l).html(h.messagingValidationInvalidRecipients+"<br />"+f.getText()),a.sendMessageCompleteCallback()):(b=f.mapLabelsField("UserName").join(),x(a,-1,b,r.val(),function(){g();u.hide();n.after(v(f.mapLabelsField("Name").join(", ")));n.next("."+c.sendSuccessResult).delay(2E3).fadeOut(300).promise().done(function(){d.toggleControlsWhenNewMessage(!1);$("#"+p).toggle();$(this).remove()});
f.clear();r.val("");m()},function(){g();u.hide();n.after(z(g))},!0,q))};d.toggleFavoriteMessage=function(a,b,d){var f=b.prev("input[type=hidden]"),e=1===parseInt(f.val());$.ajax({type:"POST",url:g.toggleFavoriteMessageUrl,data:{messageId:a,messageOrigin:d,IsFavorite:!e},success:function(){b.prop("title",e?h.addToFavorite:h.removeFromFavorite);b.children("img").toggleClass(c.favorite,!e).toggleClass(c.notFavorite,e);f.val(e?0:1);q(b,l.toggledFavoriteStatus)},error:CommonFunctions.alertAjaxError})};
d.toggleControlsWhenNewMessage=function(a){var b=$("."+c.messageItem);b.toggle(!a);k.emptyMessageContainer&&$("#"+k.emptyMessageContainer).toggle(0==b.length&&!a);k.cloudInboxContainer&&$("#"+k.cloudInboxContainer).toggle(!a);if(k.messagesLink){var d=$("#"+k.messagesLink);d.toggle(!a,function(){d.is(":visible")&&d.css("display","inline-block")})}};return d};
